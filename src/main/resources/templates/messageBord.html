<!DOCTYPE html>
<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>留言板</title>
</head>
<body>
<div class="middle main-right-content">
	<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
		<legend>留言板</legend>
	</fieldset>
	<div class="message-contain" id="message-contain-id">
		<ul class="layui-timeline" id="message-contain-ul-id">

		</ul>
	</div>

	<div class="layui-form layui-form-item layui-form-text margin-clean">
		<div class="layui-input-block ">
				<textarea placeholder="此时此刻,你最想说什么?" class="layui-textarea" name="content"
				          lay-verify="message"></textarea>
		</div>
		<div class="layui-input-block" style="margin-top: 10px">
			<button class="layui-btn" lay-submit lay-filter="message">我要留言</button>
		</div>
	</div>
</div>

<script th:src="@{/js/lib/jquery-1.11.2.min.js}" src="/static/js/lib/jquery-1.11.2.min.js"></script>
<script src="/static/layui/layui.js" th:src="@{/layui/layui.js}" charset="utf-8"></script>
<script>
    //layui 相关
    var layer;
    layui.use('layer', function () {
        layer = layui.layer;
    });



    layui.use('element', function () {
        var $ = layui.jquery
            , element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
        //Hash地址的定位
        var layid = location.hash.replace(/^#test=/, '');
        element.tabChange('test', layid);

        element.on('tab(test)', function (elem) {
            location.hash = 'test=' + $(this).attr('lay-id');
        });

    });

    layui.use('form', function () {
        var form = layui.form;
        form.on('submit(message)', function (data) {
            saveMessage(data.field.content);
        });
        form.verify({
            message: function (value, elem) {
                value = $.trim(value);
                if (value.length === 0) {
                    return '朋友,请输入你的想法';
                }
                if (value.length < 5) {
                    return '朋友,祝福语多多益善';
                }
                if (value.length > 80) {
                    return '亲爱的朋友,感谢真挚的祝福,80个字已经足够了';
                }
            }
        });


    })

    function lazyImageLoad() {
        layui.use('flow', function () {
            var flow = layui.flow;
            //按屏加载图片
            flow.lazyimg();
        })
    }

    window.onscroll = function () {
        lazyImageLoad();
    }

</script>
<script>
    // 业务相关

    //保存一条留言
    function saveMessage(content) {
        $.post("/comment/save", {content: content}, function (result) {
            var state = result.state;
            if (state == 401) {
                window.location.href = "/";
            }
        })
    }

    //初始化留言板内容
    function initCommentData() {
        cleanCommentData();
        getCommentData(function (pageData) {
            if (!Array.isArray(pageData)) {
                return;
            }
            $.each(pageData, function (i, data) {
                renderCommentData(data)
            })
        });
    }

    //清空留言板数据
    function cleanCommentData() {
        $("#message-contain-ul-id").html("");
    }

    //获取留言板内容
    function getCommentData(func) {
        $.post("/comment/list", {current: 1, size: 5000}, function (result) {
            if (result.state != '1') {
                layer.msg('对不起朋友,后院的小路正在维修,请稍后再试');
                return;
            }
            if (typeof func === 'function') {
                func(result.data.pageData);
            }
        });
    }

    //将留言数据追加到留言板
    function renderCommentData(data) {
        var dataHtml = '<li class="layui-timeline-item layui-anim layui-anim-scale">' +
            '<div class="layui-timeline-content layui-text">' +
            '<p class="layui-timeline-title">' +
            data.createTime + ' ' + data.userName +
            ':</p>' +
            data.content +
            '</div>\n' +
            '</li>';
        $("#message-contain-ul-id").append(dataHtml);
        pullScroll($("#message-contain-id").get(0))
    }

    //将标签的滚动条滚动到底部
    function pullScroll(elem) {
        elem.scrollTop = elem.scrollHeight;
    }

    initCommentData();

    //socket 相关
    var currentUrl = window.location.host;
    var socketUrl = 'ws://' + currentUrl.replace("http://", "") + "/message";
    var socket = new WebSocket(socketUrl);
    socket.onopen = function () {
        console.log("Socket 已打开");
    };
    //获得消息事件
    socket.onmessage = function (msg) {
        var strData = msg.data;
        var comment = $.parseJSON(strData);
        renderCommentData(comment);
        $(".layui-textarea").val('');
    };
    //关闭事件
    socket.onclose = function () {
        console.log("Socket已关闭");
    };

    //发生了错误事件
    socket.onerror = function () {
        console.log("Socket发生了错误");
    };

    $(window).unload(function () {
        socket.close();
    });


</script>
</body>
</html>